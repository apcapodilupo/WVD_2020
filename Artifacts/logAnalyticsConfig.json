{
    "$schema": "http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {

        "hostpoolName": {
            "type": "string"
        },

        "vmNames": {
            "type": "array"
        },
        "workspaceName": {
            "defaultvalue": "test",
            "type": "string"
        }

    },
    "variables": {
        "subscriptionID": "[subscription().subscriptionId]",
        "resourceGroupName": "[resourceGroup().name]",
        "location": "[resourceGroup().location]",
        "perfcounterConfig": "[concat( 'perfCoutner-',uniquestring(resourceGroup().id))]",
        "settingName": "HostPool-Diag",
        "workspaceId": "[concat( '/subscriptions/',variables('subscriptionID'),'/resourceGroups/',variables('resourceGroupName'),'/providers/Microsoft.OperationalInsights/workspaces/',parameters('workspaceName'))]",
        "extensionNames": [ "OMSExtenstion" ],
        "vmInitialNumber": 0

    },
    "resources": [

        {
            "type": "Microsoft.DesktopVirtualization/hostpools/providers/diagnosticSettings",
            "apiVersion": "2017-05-01-preview",
            "name": "[concat(parameters('hostpoolName'),'/Microsoft.Insights/', variables('settingName'))]",
            "properties": {
                "workspaceId": "[variables('workspaceId')]",
                "logs": [
                    {
                        "category": "Checkpoint",
                        "enabled": true
                    },
                    {
                        "category": "Error",
                        "enabled": true
                    },
                    {
                        "category": "Management",
                        "enabled": true
                    },
                    {
                        "category": "Connection",
                        "enabled": true
                    },
                    {
                        "category": "HostRegistration",
                        "enabled": true
                    }
                ]
            }
        },
        {
            "apiVersion": "2017-03-15-preview",
            "type": "Microsoft.OperationalInsights/workspaces",
            "name": "[variables('perfcounterConfig')]",
            "location": "[variables('location')]",
            "resources": [
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "sampleWindowsEvent1",
                    "dependsOn": [
                        "[concat('Microsoft.OperationalInsights/workspaces/', variables('perfcounterConfig'))]"
                    ],
                    "kind": "WindowsEvent",
                    "properties": {
                        "eventLogName": "Application",
                        "eventTypes": [
                            {
                                "eventType": "Error"
                            },
                            {
                                "eventType": "Warning"
                            }
                        ]
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "perfcounter1",
                    "dependsOn": [
                        "[concat('Microsoft.OperationalInsights/workspaces/', variables('perfcounterConfig'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "LogicalDisk",
                        "instanceName": "C:",
                        "intervalSeconds": 60,
                        "counterName": "% Free Space"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "perfcounter2",
                    "dependsOn": [
                        "[concat('Microsoft.OperationalInsights/workspaces/', variables('perfcounterConfig'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "LogicalDisk",
                        "instanceName": "C:",
                        "intervalSeconds": 30,
                        "counterName": "Avg. Disk Queue Length"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "perfcounter3",
                    "dependsOn": [
                        "[concat('Microsoft.OperationalInsights/workspaces/', variables('perfcounterConfig'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "LogicalDisk",
                        "instanceName": "C:",
                        "intervalSeconds": 60,
                        "counterName": "Avg. Disk sec/Transfer"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "perfcounter4",
                    "dependsOn": [
                        "[concat('Microsoft.OperationalInsights/workspaces/', variables('perfcounterConfig'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "LogicalDisk",
                        "instanceName": "C:",
                        "intervalSeconds": 30,
                        "counterName": "Current Disk Queue Length"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "perfcounter5",
                    "dependsOn": [
                        "[concat('Microsoft.OperationalInsights/workspaces/', variables('perfcounterConfig'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "Memory",
                        "instanceName": "*",
                        "intervalSeconds": 30,
                        "counterName": "Available Mbytes"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "perfcounter6",
                    "dependsOn": [
                        "[concat('Microsoft.OperationalInsights/workspaces/', variables('perfcounterConfig'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "Memory",
                        "instanceName": "*",
                        "intervalSeconds": 30,
                        "counterName": "Page Faults/sec"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "perfcounter7",
                    "dependsOn": [
                        "[concat('Microsoft.OperationalInsights/workspaces/', variables('perfcounterConfig'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "Memory",
                        "instanceName": "*",
                        "intervalSeconds": 30,
                        "counterName": "Pages/sec"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "perfcounter8",
                    "dependsOn": [
                        "[concat('Microsoft.OperationalInsights/workspaces/', variables('perfcounterConfig'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "Memory",
                        "instanceName": "*",
                        "intervalSeconds": 30,
                        "counterName": "% Committed Bytes In Use"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "perfcounter9",
                    "dependsOn": [
                        "[concat('Microsoft.OperationalInsights/workspaces/', variables('perfcounterConfig'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "PhysicalDisk",
                        "instanceName": "*",
                        "intervalSeconds": 30,
                        "counterName": "Avg. Disk Queue Length"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "perfcounter10",
                    "dependsOn": [
                        "[concat('Microsoft.OperationalInsights/workspaces/', variables('perfcounterConfig'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "PhysicalDisk",
                        "instanceName": "*",
                        "intervalSeconds": 30,
                        "counterName": "Avg. Disk sec/Read"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "perfcounter11",
                    "dependsOn": [
                        "[concat('Microsoft.OperationalInsights/workspaces/', variables('perfcounterConfig'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "PhysicalDisk",
                        "instanceName": "*",
                        "intervalSeconds": 30,
                        "counterName": "Avg. Disk sec/Transfer"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "perfcounter12",
                    "dependsOn": [
                        "[concat('Microsoft.OperationalInsights/workspaces/', variables('perfcounterConfig'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "PhysicalDisk",
                        "instanceName": "*",
                        "intervalSeconds": 30,
                        "counterName": "Avg. Disk sec/Write"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "perfcounter13",
                    "dependsOn": [
                        "[concat('Microsoft.OperationalInsights/workspaces/', variables('perfcounterConfig'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "Process",
                        "instanceName": "*",
                        "intervalSeconds": 30,
                        "counterName": "% User Time"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "perfcounter14",
                    "dependsOn": [
                        "[concat('Microsoft.OperationalInsights/workspaces/', variables('perfcounterConfig'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "Process",
                        "instanceName": "*",
                        "intervalSeconds": 30,
                        "counterName": "Thread Count"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "perfcounter15",
                    "dependsOn": [
                        "[concat('Microsoft.OperationalInsights/workspaces/', variables('perfcounterConfig'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "Process",
                        "instanceName": "*",
                        "intervalSeconds": 20,
                        "counterName": "% Processor Time"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "perfcounter16",
                    "dependsOn": [
                        "[concat('Microsoft.OperationalInsights/workspaces/', variables('perfcounterConfig'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "Process",
                        "instanceName": "*",
                        "intervalSeconds": 30,
                        "counterName": "IO Write Operations/sec"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "perfcounter17",
                    "dependsOn": [
                        "[concat('Microsoft.OperationalInsights/workspaces/', variables('perfcounterConfig'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "Process",
                        "instanceName": "*",
                        "intervalSeconds": 30,
                        "counterName": "IO Read Operations/sec"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "perfcounter18",
                    "dependsOn": [
                        "[concat('Microsoft.OperationalInsights/workspaces/', variables('perfcounterConfig'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "Processor Information",
                        "instanceName": "_Total",
                        "intervalSeconds": 30,
                        "counterName": "% Processor Time"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "perfcounter19",
                    "dependsOn": [
                        "[concat('Microsoft.OperationalInsights/workspaces/', variables('perfcounterConfig'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "Terminal Services",
                        "instanceName": "*",
                        "intervalSeconds": 60,
                        "counterName": "Active Sessions"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "perfcounter20",
                    "dependsOn": [
                        "[concat('Microsoft.OperationalInsights/workspaces/', variables('perfcounterConfig'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "Terminal Services",
                        "instanceName": "*",
                        "intervalSeconds": 60,
                        "counterName": "Inactive Sessions"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "perfcounter21",
                    "dependsOn": [
                        "[concat('Microsoft.OperationalInsights/workspaces/', variables('perfcounterConfig'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "Terminal Services",
                        "instanceName": "*",
                        "intervalSeconds": 60,
                        "counterName": "Total Sessions"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "perfcounter22",
                    "dependsOn": [
                        "[concat('Microsoft.OperationalInsights/workspaces/', variables('perfcounterConfig'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "User Input Delay per Process",
                        "instanceName": "*",
                        "intervalSeconds": 30,
                        "counterName": "Max Input Delay"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "perfcounter23",
                    "dependsOn": [
                        "[concat('Microsoft.OperationalInsights/workspaces/', variables('perfcounterConfig'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "User Input Delay per Session",
                        "instanceName": "*",
                        "intervalSeconds": 30,
                        "counterName": "Max Input Delay"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "perfcounter24",
                    "dependsOn": [
                        "[concat('Microsoft.OperationalInsights/workspaces/', variables('perfcounterConfig'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "RemoteFX Network",
                        "instanceName": "*",
                        "intervalSeconds": 30,
                        "counterName": "Current TCP RTT"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "perfcounter25",
                    "dependsOn": [
                        "[concat('Microsoft.OperationalInsights/workspaces/', variables('perfcounterConfig'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "RemoteFX Network",
                        "instanceName": "*",
                        "intervalSeconds": 30,
                        "counterName": "Current UDP Bandwidth"
                    }
                }
            ]
        },
        
        {
            "apiVersion": "2018-10-01",
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "name": "[concat(parameters('workspaceName'), '/', 'installOMSAgent')]",
            "condition": "[greater(length(parameters('vmNames')), 0)]",
            "location": "[variables('location')]",
            "copy": {
                "name": "vmextensioncopy",
                "count": "[length(parameters('vmNames'))]"
            },
            "properties": {
                "publisher": "Microsoft.EnterpriseCloud.Monitoring",
                "type": "MicrosoftMonitoringAgent",
                "typeHandlerVersion": "1.0",
                "autoUpgradeMinorVersion": true,
                "settings": {
                    "workspaceId": "[reference(variables('workspaceId'), '2017-03-15-preview').customerId]"
                },
                "protectedSettings": {
                    "workspaceKey": "[listKeys(variables('workspaceId'), '2015-11-01-preview').primarySharedKey]"
                }
            }
        }
    ]
}